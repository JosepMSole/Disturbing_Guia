<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Disturbing Stories - Scroll</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #fff;
      background: #050816;
      overflow-x: hidden;
    }

    .bg-video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 0;
      background: #000;
    }

    .bg-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, rgba(0,0,0,0.35), rgba(0,0,0,0.85));
      z-index: 1;
    }

    .fx-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 4;
      pointer-events: none;
      opacity: 0.6;
      mix-blend-mode: screen;
    }

    .page-content {
      position: relative;
      z-index: 2;
    }

    .section {
      position: relative;
      min-height: 100vh;
      height: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      gap: 2.2rem;
      overflow: hidden;
    }

    .content {
      position: relative;
      width: 100%;
      max-width: 780px;
      text-align: center;
      z-index: 3;
      padding: 1.5rem 0;
      background: transparent;
      border-radius: 0;
      border: none;
      box-shadow: none;
      backdrop-filter: none;
      margin: 0 auto;
    }

    .content h1 {
      font-size: clamp(1.9rem, 3.2vw, 2.6rem);
      margin-bottom: 0.6rem;
      text-transform: uppercase;
      position: relative;
    }

    .content p {
      font-size: 1.02rem;
      opacity: 0.9;
      line-height: 1.7;
      max-width: 620px;
      margin: 0.4rem auto 0;
      min-height: 4em;
      letter-spacing: 0.01em;
    }

    .typing-cursor::after {
      content: "‚ñã";
      display: inline-block;
      margin-left: 3px;
      animation: blink 0.7s steps(1, start) infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      50.01%, 100% { opacity: 0; }
    }

    .logo-main {
      width: 100%;
      max-width: 840px;
      display: block;
      margin: 0 auto 1.2rem auto;
      opacity: 0;
      transform: scale(0.7) translateY(30px);
      filter: blur(6px) brightness(0.7);
      transition:
        opacity 0.25s ease-out,
        filter 0.35s ease-out;
    }

    .logo-main.visible {
      opacity: 1;
      filter: blur(0) brightness(1);
      animation:
        iconAppear 0.6s cubic-bezier(0.19, 1, 0.22, 1) forwards,
        iconFloat 3.4s ease-in-out 0.6s infinite;
    }

    .bookz-link {
      display: block;
      width: 100%;
      max-width: 1080px;
      margin: 1.3rem auto 0 auto;
      text-decoration: none;
    }

    .bookz {
      display: block;
      width: 100%;
      height: auto;
      opacity: 0;
      transform: scale(0.3) translateY(40px);
      filter: blur(8px) brightness(0.6) contrast(1.3);
      transition:
        opacity 0.25s ease-out,
        filter 0.35s ease-out;
      cursor: pointer;
    }

    .bookz.visible {
      opacity: 1;
      filter: blur(0) brightness(1) contrast(1);
      animation:
        iconAppear 0.6s cubic-bezier(0.19, 1, 0.22, 1) forwards,
        iconFloat 3.8s ease-in-out 0.6s infinite;
    }

    .bot {
      position: fixed;
      width: 600px;
      max-width: 60vw;
      height: auto;
      top: 50%;
      left: 50%;
      z-index: 2;
      pointer-events: auto;
      cursor: pointer;
      opacity: 0.9;
      transition: top 0.6s ease, left 0.6s ease;
      filter: drop-shadow(0 0 18px rgba(255,255,255,0.35));
      --botScale: 1;
      animation: botFloat 3.8s ease-in-out infinite;
    }

    @keyframes botFloat {
      0% {
        transform: translate(-50%, -50%) scale(var(--botScale));
      }
      50% {
        transform: translate(-50%, -54%) scale(calc(var(--botScale) * 1.03));
      }
      100% {
        transform: translate(-50%, -50%) scale(var(--botScale));
      }
    }

    body.state-1 .bot {
      left: 18%;
      top: 60%;
      --botScale: 0.75;
    }

    body.state-2 .bot {
      left: 82%;
      top: 70%;
      --botScale: 1.05;
    }

    body.state-3 .bot {
      left: 18%;
      top: 110%;
      --botScale: 1.5;
    }

    body.state-4 .bot {
      left: 82%;
      top: 80%;
      --botScale: 1.08;
    }

    body.state-5 .bot {
      left: 50%;
      top: 85%;
      --botScale: 1;
    }

    .tk-bubble {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -120%);
      max-width: 420px;
      padding: 0.8rem 1rem;
      background: rgba(8, 10, 24, 0.96);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow:
        0 10px 30px rgba(0,0,0,0.8),
        0 0 20px rgba(0,255,200,0.25);
      font-size: 0.9rem;
      line-height: 1.5;
      opacity: 0;
      pointer-events: none;
      z-index: 5;
      transition: opacity 0.25s ease-out, transform 0.25s ease-out;
    }

    .tk-bubble.visible {
      opacity: 1;
      transform: translate(-50%, -135%);
    }

    .tk-bubble::after {
      content: "";
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 10px 10px 0 10px;
      border-style: solid;
      border-color: rgba(8,10,24,0.96) transparent transparent transparent;
      filter: drop-shadow(0 -2px 2px rgba(0,0,0,0.7));
    }

    .tk-bubble-text {
      min-height: 2.2em;
    }

    .section-icon {
      width: 320px;
      height: 320px;
      opacity: 0;
      transform: scale(0.3) translateY(40px);
      filter: blur(8px) brightness(0.4) contrast(1.4);
      transition:
        opacity 0.25s ease-out,
        filter 0.35s ease-out;
      z-index: 4;
      align-self: center;
    }

    .section-icon img {
      display: block;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .section-icon.visible {
      opacity: 1;
      filter: blur(0px) brightness(1) contrast(1);
      animation:
        iconAppear 0.6s cubic-bezier(0.19, 1, 0.22, 1) forwards,
        iconFloat 3.8s ease-in-out 0.6s infinite;
    }

    @keyframes iconAppear {
      0% {
        transform: scale(0.2) translateY(60px) skewX(-8deg);
        filter: blur(12px) brightness(2) contrast(1.8) hue-rotate(10deg);
      }
      35% {
        transform: scale(1.1) translateY(-12px) skewX(3deg);
        filter: blur(3px) brightness(1.4) contrast(1.6) hue-rotate(-12deg);
      }
      65% {
        transform: scale(0.96) translateY(6px) skewX(-2deg);
        filter: blur(1px) brightness(0.9) contrast(1.1);
      }
      100% {
        transform: scale(1) translateY(0) skewX(0deg);
        filter: blur(0) brightness(1) contrast(1);
      }
    }

    @keyframes iconFloat {
      0%   { transform: translate(-4px, 0) scale(1); }
      25%  { transform: translate(4px, -20px) scale(1.05); }
      50%  { transform: translate(2px, 0) scale(1.02); }
      75%  { transform: translate(-4px, -16px) scale(1.06); }
      100% { transform: translate(0, 0) scale(1); }
    }

    .title-glitch {
      animation: titleGlitch 2s steps(2, end) infinite;
    }

    @keyframes titleGlitch {
      0% {
        text-shadow:
          -2px 0 rgba(0,255,255,0.6),
           2px 0 rgba(255,0,128,0.6);
        transform: translate(0, 0);
      }
      15% {
        text-shadow:
          -4px 0 rgba(0,255,255,0.8),
           3px 0 rgba(255,0,128,0.8);
        transform: translate(-1px, 0);
      }
      30% {
        text-shadow:
           3px 0 rgba(0,255,255,0.8),
          -3px 0 rgba(255,0,128,0.8);
        transform: translate(1px, 0);
      }
      45% {
        text-shadow:
          -2px 0 rgba(0,255,255,0.7),
           2px 0 rgba(255,0,128,0.7);
        transform: translate(-1px, 0);
      }
      60% {
        text-shadow:
           1px 0 rgba(0,255,255,0.4),
          -1px 0 rgba(255,0,128,0.4);
        transform: translate(1px, 0);
      }
      100% {
        text-shadow: none;
        transform: translate(0,0);
      }
    }

    .icon-pos-right,
    .icon-pos-left,
    .icon-pos-center-bottom {
      align-self: center;
    }

    .footer {
      text-align: center;
      font-size: 0.75rem;
      opacity: 0.7;
      padding: 0.75rem 1rem 1.5rem;
      margin-top: -1rem;
      z-index: 3;
      position: relative;
    }

    .footer a {
      color: #ffffff;
      text-decoration: none;
      border-bottom: 1px solid rgba(255,255,255,0.4);
    }

    .footer a:hover {
      border-bottom-color: rgba(255,255,255,0.8);
    }

    .scroll-indicator {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 6;
      display: flex;
      gap: 22px;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .volume-wrapper {
      pointer-events: auto;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,0.55);
      box-shadow: 0 0 12px rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 140px;
      gap: 8px;
    }

    .volume-icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #000;
      box-shadow: 0 0 10px rgba(255,255,255,0.8);
      flex-shrink: 0;
    }

    #volumeSlider {
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.35);
      outline: none;
    }

    #volumeSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #ffffff;
      box-shadow: 0 0 12px rgba(255,255,255,0.9);
      cursor: pointer;
      margin-top: -6px;
    }

    #volumeSlider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #ffffff;
      box-shadow: 0 0 12px rgba(255,255,255,0.9);
      cursor: pointer;
    }

    .scroll-dot {
      position: relative;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.4);
      box-shadow: 0 0 0 2px rgba(0,0,0,0.7);
      cursor: pointer;
      pointer-events: auto;
      transition: transform 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .scroll-dot::before {
      content: attr(data-index);
      font-weight: 700;
      font-size: 18px;
      color: #000;
    }

    .scroll-dot::after {
      content: "";
      position: absolute;
      left: 50%;
      top: 100%;
      border-width: 9px 7px 0 7px;
      border-style: solid;
      border-color: #ffffff transparent transparent transparent;
      opacity: 0;
      transform: translate(-50%, 8px) scale(0.9);
    }

    .scroll-dot.active {
      background: #ffffff;
      box-shadow: 0 0 18px rgba(255,255,255,0.95);
      transform: scale(1.35);
    }

    .scroll-dot.active::after {
      opacity: 1;
      animation: arrowPulse 0.8s ease-in-out infinite;
    }

    @keyframes arrowPulse {
      0% {
        transform: translate(-50%, 6px) scale(0.9);
      }
      50% {
        transform: translate(-50%, 14px) scale(1.08);
      }
      100% {
        transform: translate(-50%, 6px) scale(0.9);
      }
    }

    .bot-prompt {
      position: fixed;
      z-index: 6;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      opacity: 0;
      pointer-events: none;
      transform: translate(-50%, -50%);
      transition: opacity 0.25s ease-out;
    }

    .bot-prompt.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .bot-sphere {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background:
        radial-gradient(circle at 30% 30%, #ffffff, #0ff 50%, #00b3ff 80%, #0066ff 100%);
      box-shadow:
        0 0 16px rgba(0,255,255,0.9),
        0 0 28px rgba(0, 0, 0, 0.9);
      cursor: pointer;
    }

    .bot-sphere:hover {
      transform: scale(1.08);
      box-shadow:
        0 0 20px rgba(0,255,255,1),
        0 0 32px rgba(0, 0, 0, 0.9);
    }

    .bot-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(8,10,24,0.9);
      border: 1px solid rgba(255,255,255,0.6);
      box-shadow:
        0 0 10px rgba(0,0,0,0.9),
        0 0 12px rgba(0,255,255,0.4);
      white-space: nowrap;
    }

    .tk-prompt {
      position: fixed;
      z-index: 6;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      opacity: 0;
      pointer-events: none;
      transform: translate(-50%, -50%);
      transition: opacity 0.25s ease-out;
    }

    .tk-prompt.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .tk-sphere {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background:
        radial-gradient(circle at 30% 30%, #ffffff, #0ff 50%, #00b3ff 80%, #0066ff 100%);
      box-shadow:
        0 0 16px rgba(0,255,255,0.9),
        0 0 28px rgba(0, 0, 0, 0.9);
      cursor: pointer;
    }

    .tk-sphere:hover {
      transform: scale(1.08);
      box-shadow:
        0 0 20px rgba(0,255,255,1),
        0 0 32px rgba(0, 0, 0, 0.9);
    }

    .tk-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(8,10,24,0.9);
      border: 1px solid rgba(255,255,255,0.6);
      box-shadow:
        0 0 10px rgba(0,0,0,0.9),
        0 0 12px rgba(0,255,255,0.4);
      white-space: nowrap;
    }

    @media (max-width: 1024px) {
      .bot {
        width: 480px;
        max-width: 70vw;
      }
      .section-icon {
        width: 260px;
        height: 260px;
      }
    }

    @media (max-width: 768px) {
      .section {
        padding: 1.5rem 1rem;
        gap: 1.6rem;
      }
      .content {
        padding: 1.25rem 0;
        max-width: 94vw;
      }
      .content p {
        max-width: 100%;
      }

      .bot {
        width: 260px;
        max-width: 65vw;
      }

      body.state-1 .bot,
      body.state-2 .bot,
      body.state-3 .bot,
      body.state-4 .bot,
      body.state-5 .bot {
        left: 50%;
        top: 78%;
        --botScale: 1;
      }

      .bot-sphere,
      .tk-sphere {
        width: 32px;
        height: 32px;
      }

      .section-icon {
        width: min(65vw, 240px);
        height: auto;
      }
      .bookz-link {
        max-width: 90vw;
      }
      .tk-bubble {
        max-width: 90vw;
        font-size: 0.85rem;
      }

      .scroll-indicator {
        top: 10px;
        gap: 18px;
      }

      .scroll-dot {
        width: 60px;
        height: 60px;
      }

      .scroll-dot::before {
        font-size: 20px;
      }

      .volume-wrapper {
        min-width: 150px;
      }

      #volumeSlider {
        height: 8px;
      }

      #volumeSlider::-webkit-slider-thumb {
        width: 20px;
        height: 20px;
        margin-top: -6px;
      }

      #volumeSlider::-moz-range-thumb {
        width: 20px;
        height: 20px;
      }
    }

    @media (max-width: 480px) {
      .content {
        padding: 1rem 0;
      }
      .bot {
        width: 230px;
      }
    }

  </style>
</head>
<body class="state-1">

  <video class="bg-video" autoplay muted loop playsinline preload="auto">
    <source src="ASSETS/BG_WEBGUIA_v1_LQ.mp4" type="video/mp4">
  </video>

  <div class="bg-overlay"></div>

  <video class="fx-overlay" autoplay muted loop playsinline>
    <source src="ASSETS/OVERLAY.webm" type="video/webm">
  </video>

  <audio id="bgMusic" src="ASSETS/BG_MUSIC.mp3" preload="auto" loop></audio>

  <div class="page-content">

    <section class="section">
      <div class="content">
        <img
          src="ASSETS/LOGO_COLECCION_1.png"
          alt="Disturbing Stories Logo"
          class="logo-main"
        >
        <p>
          Disturbing Stories es la puerta de entrada a un universo donde el terror y la ciencia ficci√≥n
          se entrelazan para mostrar aquello que habita entre las grietas de lo real.
        </p>
      </div>
    </section>

    <section class="section">
      <div class="content">
        <h1>300 RELATOS, 20 LIBROS</h1>
        <p>
          Sus 300 relatos, repartidos en 20 libros, exploran sucesos inexplicables, criaturas ocultas
          y fen√≥menos que desaf√≠an toda l√≥gica humana.
        </p>
        <a
          href="https://www.disturbingstories.com/store.html#tapablanda"
          class="bookz-link"
          target="_top"
        >
          <img
            src="ASSETS/BOOKZ.png"
            alt="Libros Disturbing Stories"
            class="bookz"
          >
        </a>
      </div>
      <a
        class="section-icon icon-pos-right"
        href="https://www.disturbingstories.com/stories.html"
        target="_top"
      >
        <img src="ASSETS/ICO_STORIES.png" alt="Stories">
      </a>
    </section>

    <section class="section">
      <div class="content">
        <h1>¬°LEED, MALDIT@S!</h1>
        <p>
          Puedes leer gratis una parte de este mundo aqu√≠ en la web, pero las historias m√°s perturbadoras
          solo viven en los libros.
        </p>
      </div>
      <a
        class="section-icon icon-pos-left"
        href="https://www.disturbingstories.com/store.html"
        target="_top"
      >
        <img src="ASSETS/ICO_STORE.png" alt="Store">
      </a>
    </section>

    <section class="section">
      <div class="content">
        <h1>LAS STORIES COBRAN VIDA</h1>
        <p>
          Algunos relatos cobran vida a trav√©s de audios y cortometrajes accesibles con c√≥digos QR,
          haciendo que la experiencia traspase la pantalla.
        </p>
      </div>
      <a
        class="section-icon icon-pos-right"
        href="https://www.disturbingstories.com/media.html"
        target="_top"
      >
        <img src="ASSETS/ICO_MEDIA.png" alt="Media">
      </a>
    </section>

    <section class="section">
      <div class="content">
        <h1>AQU√ç COMIENZA TU VIAJE</h1>
        <p>
          Si buscas misterio, sorpresa y relatos que te acompa√±en incluso despu√©s de cerrar la p√°gina,
          aqu√≠ comienza tu viaje.
        </p>
      </div>
      <a
        class="section-icon icon-pos-center-bottom"
        href="https://www.disturbingstories.com/random.html"
        target="_top"
      >
        <img src="ASSETS/ICO_RANDOM.png" alt="Random">
      </a>
    </section>

    <video class="bot" autoplay muted loop playsinline>
      <source src="ASSETS/TK__Loop1.webm" type="video/webm">
    </video>

    <div class="footer">
      ¬© Todos los derechos reservados.
      <a href="https://www.disturbingstories.com" target="_top">DISTURBINGSTORIES:COM</a>
    </div>

  </div>

  <div class="tk-bubble" id="tkBubble">
    <div class="tk-bubble-text" id="tkBubbleText"></div>
  </div>

  <div class="scroll-indicator">
    <div class="volume-wrapper">
      <div class="volume-icon">üîä</div>
      <input type="range" id="volumeSlider" min="0" max="100" value="40">
    </div>
    <button class="scroll-dot" data-index="1" type="button"></button>
    <button class="scroll-dot" data-index="2" type="button"></button>
    <button class="scroll-dot" data-index="3" type="button"></button>
    <button class="scroll-dot" data-index="4" type="button"></button>
    <button class="scroll-dot" data-index="5" type="button"></button>
  </div>

  <div class="bot-prompt" id="botPrompt">
    <div class="bot-sphere" id="botSphere"></div>
    <div class="bot-label">Habla</div>
  </div>

  <div class="tk-prompt visible" id="tkPrompt">
    <div class="tk-sphere" id="tkSphere"></div>
    <div class="tk-label">Habla</div>
  </div>

  <script>
    const sections = document.querySelectorAll(".section");
    const body = document.body;

    const paragraphs = document.querySelectorAll(".content p");
    paragraphs.forEach(p => {
      const full = p.textContent.trim();
      p.dataset.fulltext = full;
      p.textContent = "";
    });

    function typeWriter(el, text, onComplete) {
      const totalDuration = 1000;
      const len = text.length || 1;
      const delay = totalDuration / len;

      let i = 0;
      el.classList.add("typing-cursor");

      function step() {
        el.textContent = text.slice(0, i);
        i++;
        if (i <= text.length) {
          setTimeout(step, delay);
        } else {
          el.classList.remove("typing-cursor");
          el.dataset.typed = "true";
          if (typeof onComplete === "function") onComplete();
        }
      }

      step();
    }

    const scrollDots = document.querySelectorAll(".scroll-dot");

    function setActiveDot(idx) {
      scrollDots.forEach(dot => {
        const dotIndex = parseInt(dot.dataset.index, 10);
        dot.classList.toggle("active", dotIndex === idx);
      });
    }

    function goToSection(idx) {
      for (let i = 1; i <= 5; i++) {
        body.classList.remove("state-" + i);
      }
      body.classList.add("state-" + idx);
      setActiveDot(idx);
      updateBotPrompt(idx);
      refreshUiPositions();

      const target = sections[idx - 1];
      if (target) {
        target.scrollIntoView({ behavior: "smooth" });
      }
    }

    scrollDots.forEach(dot => {
      dot.addEventListener("click", () => {
        const idx = parseInt(dot.dataset.index, 10);
        goToSection(idx);
      });
    });

    setActiveDot(1);

    const bot = document.querySelector(".bot");
    const botPrompt = document.getElementById("botPrompt");
    const botSphere = document.getElementById("botSphere");
    const sectionSpoken = { 2: false, 3: false, 4: false, 5: false };

    function getCurrentStateIndex() {
      for (let i = 1; i <= 5; i++) {
        if (body.classList.contains("state-" + i)) {
          return i;
        }
      }
      return 1;
    }

    let botPromptTracking = false;

    function positionBotPrompt() {
      if (!botPrompt || !bot) return;
      const rect = bot.getBoundingClientRect();
      const state = getCurrentStateIndex();
      const isMobile = window.innerWidth <= 768;

      const x = rect.left + rect.width / 2;
      let y;

      if (isMobile) {
        y = rect.top + rect.height * 0.82;
      } else {
        if (state === 3) {
          y = rect.top + rect.height * 0.15;
        } else {
          y = rect.top + rect.height * 0.45;
        }
      }

      botPrompt.style.left = x + "px";
      botPrompt.style.top  = y + "px";
    }

    function startBotPromptTracking() {
      if (botPromptTracking) return;
      botPromptTracking = true;

      function track() {
        if (!botPromptTracking) return;
        positionBotPrompt();
        requestAnimationFrame(track);
      }

      requestAnimationFrame(track);
    }

    function stopBotPromptTracking() {
      botPromptTracking = false;
    }

    function hideBotPrompt() {
      if (botPrompt) {
        botPrompt.classList.remove("visible");
      }
      stopBotPromptTracking();
    }

    function updateBotPrompt(idx) {
      if (!botPrompt) return;
      if (idx >= 2 && idx <= 5 && !sectionSpoken[idx]) {
        botPrompt.classList.add("visible");
        positionBotPrompt();
        startBotPromptTracking();
      } else {
        hideBotPrompt();
      }
    }

    const tkBubble = document.getElementById("tkBubble");
    const tkBubbleText = document.getElementById("tkBubbleText");
    const tkAudio = new Audio();

    const tkDialog = {
      1: "¬°Hola! ¬°Soy T.K.! Y te acompa√±ar√© en esta peque√±a gu√≠a en la que descubrir√°s qu√© es Disturbing Stories.",
      2: "Actualmente en publicaci√≥n.",
      3: "No hay excusa para no leer unas cuantas stories...",
      4: "Cassettes y Tapes que te sumergir√°n en las stories...",
      5: "¬°Vamos, atr√©vete a entrar!"
    };

    const tkAudioMap = {
      1: "ASSETS/TK_Frase1.mp3",
      2: "ASSETS/TK_Frase2.mp3",
      3: "ASSETS/TK_Frase3.mp3",
      4: "ASSETS/TK_Frase4.mp3",
      5: "ASSETS/TK_Frase5.mp3"
    };

    let bubbleTimeouts = [];
    let bubbleHideTimeout = null;

    function clearBubbleTyping() {
      bubbleTimeouts.forEach(id => clearTimeout(id));
      bubbleTimeouts = [];
    }

    function typeBubble(text) {
      clearBubbleTyping();
      tkBubbleText.textContent = "";
      const totalDuration = 2000;
      const len = text.length || 1;
      const delay = totalDuration / len;
      let i = 0;

      function step() {
        tkBubbleText.textContent = text.slice(0, i);
        i++;
        if (i <= text.length) {
          const id = setTimeout(step, delay);
          bubbleTimeouts.push(id);
        }
      }

      step();
    }

    const tkPrompt = document.getElementById("tkPrompt");
    const tkSphere = document.getElementById("tkSphere");
    let tkPromptVisible = true;
    let tkPromptTracking = false;

    function positionTkPrompt() {
      if (!tkPrompt || !tkPromptVisible || !bot) return;
      const rect = bot.getBoundingClientRect();
      const isMobile = window.innerWidth <= 768;
      const x = rect.left + rect.width / 2;
      let y;

      if (isMobile) {
        y = rect.top + rect.height * 0.82;
      } else {
        y = rect.top + rect.height * 0.45;
      }

      tkPrompt.style.left = x + "px";
      tkPrompt.style.top  = y + "px";
    }

    function startTkPromptTracking() {
      if (tkPromptTracking) return;
      tkPromptTracking = true;

      function track() {
        if (!tkPromptTracking) return;
        if (tkPromptVisible) positionTkPrompt();
        requestAnimationFrame(track);
      }

      requestAnimationFrame(track);
    }

    function stopTkPromptTracking() {
      tkPromptTracking = false;
    }

    function hideTkPrompt() {
      if (!tkPromptVisible) return;
      tkPromptVisible = false;
      if (tkPrompt) tkPrompt.classList.remove("visible");
      stopTkPromptTracking();
    }

    function refreshUiPositions() {
      positionTkPrompt();
      positionBotPrompt();
    }

    window.addEventListener("load", () => {
      refreshUiPositions();
      startTkPromptTracking();
    });
    window.addEventListener("resize", refreshUiPositions);
    window.addEventListener("scroll", refreshUiPositions);

    let currentVolume = 0.4;

    function applyVolume() {
      bgMusicEl.volume = currentVolume;
      tkAudio.volume = currentVolume;
    }

    function handleSpeak(fromSphere) {
      if (tkPromptVisible) {
        hideTkPrompt();
      }

      let idx = getCurrentStateIndex();

      const text = tkDialog[idx];
      const audioSrc = tkAudioMap[idx];
      if (!text || !audioSrc) return;

      const rect = bot.getBoundingClientRect();
      const bubbleX = rect.left + rect.width / 2;
      const bubbleY = rect.top + rect.height * 0.35;

      tkBubble.style.left = bubbleX + "px";
      tkBubble.style.top  = bubbleY + "px";

      tkBubble.classList.add("visible");

      if (bubbleHideTimeout) {
        clearTimeout(bubbleHideTimeout);
      }
      bubbleHideTimeout = setTimeout(() => {
        tkBubble.classList.remove("visible");
      }, 5000);

      try {
        tkAudio.pause();
        tkAudio.currentTime = 0;
        tkAudio.src = audioSrc;
        tkAudio.volume = currentVolume;
        tkAudio.play();
      } catch (e) {}

      typeBubble(text);

      if (fromSphere && idx >= 2 && idx <= 5) {
        sectionSpoken[idx] = true;
        hideBotPrompt();
      }
    }

    bot.addEventListener("click", () => {
      handleSpeak(false);
    });

    if (botSphere) {
      botSphere.addEventListener("click", (ev) => {
        ev.stopPropagation();
        handleSpeak(true);
      });
    }

    if (tkSphere) {
      tkSphere.addEventListener("click", (ev) => {
        ev.stopPropagation();
        handleSpeak(true);
      });
    }

    const bgMusicEl = document.getElementById("bgMusic");
    bgMusicEl.volume = currentVolume;

    let bgStarted = false;

    function startBgMusic() {
      if (bgStarted) return;
      bgStarted = true;
      bgMusicEl.play().catch(err => {
        bgStarted = false;
      });
    }

    const bgVideoEl = document.querySelector(".bg-video");
    if (bgVideoEl) {
      bgVideoEl.addEventListener("play", () => {
        startBgMusic();
      });
    }

    window.addEventListener("click", startBgMusic);
    window.addEventListener("keydown", startBgMusic);

    function preventUserScroll(e) {
      e.preventDefault();
    }

    window.addEventListener("touchmove", preventUserScroll, { passive: false });
    window.addEventListener("wheel", preventUserScroll, { passive: false });

    window.addEventListener("keydown", (e) => {
      const keys = ["ArrowUp", "ArrowDown", "PageUp", "PageDown", "Home", "End", "Space", " "];
      if (keys.includes(e.code) || keys.includes(e.key)) {
        e.preventDefault();
      }
    });

    const observer = new IntersectionObserver(
      entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const idx = Array.from(sections).indexOf(entry.target) + 1;

            for (let i = 1; i <= 5; i++) {
              body.classList.remove("state-" + i);
            }
            body.classList.add("state-" + idx);

            if (idx > 1) {
              hideTkPrompt();
            }

            refreshUiPositions();
            setActiveDot(idx);
            updateBotPrompt(idx);

            const p = entry.target.querySelector(".content p");
            const icon = entry.target.querySelector(".section-icon");
            const logo = entry.target.querySelector(".logo-main");
            const bookz = entry.target.querySelector(".bookz");
            const title = entry.target.querySelector(".content h1");

            const afterTyping = () => {
              if (icon) icon.classList.add("visible");
              if (logo) logo.classList.add("visible");
              if (bookz) bookz.classList.add("visible");
              if (title) title.classList.add("title-glitch");
            };

            if (p && !p.dataset.typed) {
              typeWriter(p, p.dataset.fulltext, afterTyping);
            } else {
              afterTyping();
            }
          }
        });
      },
      { threshold: 0.6 }
    );

    sections.forEach(sec => observer.observe(sec));

    const volumeSlider = document.getElementById("volumeSlider");

    function setVolumeFromSlider() {
      const v = parseInt(volumeSlider.value, 10);
      currentVolume = Math.max(0, Math.min(1, v / 100));
      applyVolume();
      if (!bgStarted && currentVolume > 0) {
        startBgMusic();
      }
    }

    volumeSlider.addEventListener("input", setVolumeFromSlider);
    applyVolume();
  </script>

</body>
</html>
